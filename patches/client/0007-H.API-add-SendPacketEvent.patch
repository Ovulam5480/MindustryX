From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Fri, 23 Jun 2023 16:18:22 +0800
Subject: [PATCH] H.API: add SendPacketEvent

---
 core/src/mindustry/net/ArcNetProvider.java | 3 +++
 core/src/mindustry/net/Net.java            | 6 +++++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/core/src/mindustry/net/ArcNetProvider.java b/core/src/mindustry/net/ArcNetProvider.java
index 3eaeacd1f3ea9436ba8b67b9a04b1a40cad02a5c..80e9b6b7317ac124d936bebce0e4481e2a31721c 100644
--- a/core/src/mindustry/net/ArcNetProvider.java
+++ b/core/src/mindustry/net/ArcNetProvider.java
@@ -15,6 +15,7 @@ import mindustry.game.EventType.*;
 import mindustry.net.Administration.*;
 import mindustry.net.Net.*;
 import mindustry.net.Packets.*;
+import mindustryX.events.*;
 import net.jpountz.lz4.*;
 
 import java.io.*;
@@ -329,6 +330,7 @@ public class ArcNetProvider implements NetProvider{
 
         @Override
         public void sendStream(Streamable stream){
+            if(SendPacketEvent.emit(this, null, stream)) return;
             connection.addListener(new InputStreamSender(stream.stream, 1024){
                 int id;
 
@@ -354,6 +356,7 @@ public class ArcNetProvider implements NetProvider{
 
         @Override
         public void send(Object object, boolean reliable){
+            if(SendPacketEvent.emit(this, null, object)) return;
             try{
                 if(reliable){
                     connection.sendTCP(object);
diff --git a/core/src/mindustry/net/Net.java b/core/src/mindustry/net/Net.java
index ef69c392b08de46d8994610b3ffb5ebdd64ab41a..6f9b8f9b50079b42f7762c8ee2b1101394b54e33 100644
--- a/core/src/mindustry/net/Net.java
+++ b/core/src/mindustry/net/Net.java
@@ -9,6 +9,7 @@ import mindustry.game.EventType.*;
 import mindustry.gen.*;
 import mindustry.net.Packets.*;
 import mindustry.net.Streamable.*;
+import mindustryX.events.*;
 import net.jpountz.lz4.*;
 
 import java.io.*;
@@ -222,8 +223,10 @@ public class Net{
 
     /** Send an object to all connected clients, or to the server if this is a client.*/
     public void send(Object object, boolean reliable){
+        if(SendPacketEvent.emit(null, null, object)) return;
         if(server){
             for(NetConnection con : provider.getConnections()){
+                if(!con.hasBegunConnecting) continue;
                 con.send(object, reliable);
             }
         }else{
@@ -233,8 +236,9 @@ public class Net{
 
     /** Send an object to everyone EXCEPT a certain client. Server-side only.*/
     public void sendExcept(NetConnection except, Object object, boolean reliable){
+        if(SendPacketEvent.emit(null, except, object)) return;
         for(NetConnection con : getConnections()){
-            if(con != except){
+            if(con != except && con.hasBegunConnecting){
                 con.send(object, reliable);
             }
         }

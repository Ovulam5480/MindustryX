From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Tue, 16 Apr 2024 21:44:18 +0800
Subject: [PATCH] =?UTF-8?q?FC:=20MarkerType=20=E6=A0=87=E8=AE=B0=E5=8A=9F?=
 =?UTF-8?q?=E8=83=BD(=E9=87=8D=E5=88=B6)?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

支持\t前缀
way-zer <himc.wicp@gmail.com> on 2024/6/10
---
 core/src/mindustry/input/Binding.java         |   2 +
 .../mindustry/ui/fragments/ChatFragment.java  |   4 +-
 core/src/mindustryX/Hooks.java                |   9 +
 core/src/mindustryX/features/MarkerType.java  | 215 ++++++++++++++++++
 core/src/mindustryX/features/UIExt.java       |  23 +-
 5 files changed, 245 insertions(+), 8 deletions(-)
 create mode 100644 core/src/mindustryX/features/MarkerType.java

diff --git a/core/src/mindustry/input/Binding.java b/core/src/mindustry/input/Binding.java
index b4ddb5af181ffd4515f59b267b6558f1e84a337a..efd2697aac27d4f14ee51de2f9b8cfee3c728402 100644
--- a/core/src/mindustry/input/Binding.java
+++ b/core/src/mindustry/input/Binding.java
@@ -91,6 +91,8 @@ public enum Binding implements KeyBind{
 
     //MDTX
     toggle_unit(KeyCode.unknown, "mindustryX"),
+    point(KeyCode.j),
+    lockonLastMark(KeyCode.unknown),
     ;
 
     private final KeybindValue defaultValue;
diff --git a/core/src/mindustry/ui/fragments/ChatFragment.java b/core/src/mindustry/ui/fragments/ChatFragment.java
index 7a968f1c21275eb4a571350adfcf59df1fa37df9..89b9a23ce2bb850df5c7ae99a5f964753a807662 100644
--- a/core/src/mindustry/ui/fragments/ChatFragment.java
+++ b/core/src/mindustry/ui/fragments/ChatFragment.java
@@ -30,7 +30,7 @@ public class ChatFragment extends Table{
     private boolean shown = false;
     private TextField chatfield;
     private Label fieldlabel = new Label(">");
-    private ChatMode mode = ChatMode.normal;
+    public ChatMode mode = ChatMode.normal;
     private Font font;
     private GlyphLayout layout = new GlyphLayout();
     private float offsetx = Scl.scl(4), offsety = Scl.scl(4), fontoffsetx = Scl.scl(2), chatspace = Scl.scl(50);
@@ -290,7 +290,7 @@ public class ChatFragment extends Table{
         if(scrollPos > 0) scrollPos++;
     }
 
-    private enum ChatMode{
+    public enum ChatMode{
         normal(""),
         team("/t"),
         admin("/a", player::admin)
diff --git a/core/src/mindustryX/Hooks.java b/core/src/mindustryX/Hooks.java
index 6e4a90501f429bec5075e3d11e01dc2e220d930f..3cfe589eca2f32127b659aa8c8647e8ffbb7e5eb 100644
--- a/core/src/mindustryX/Hooks.java
+++ b/core/src/mindustryX/Hooks.java
@@ -52,6 +52,9 @@ public class Hooks implements ApplicationListener{
 
     public static @Nullable String onHandleSendMessage(String message, @Nullable Player sender){
         if(message == null) return null;
+        if(Vars.ui != null){
+            if(MarkerType.resolveMessage(message)) return message;
+        }
         return message;
     }
 
@@ -65,6 +68,12 @@ public class Hooks implements ApplicationListener{
         if(Core.input.keyTap(Binding.toggle_unit)){
             RenderExt.unitHide = !RenderExt.unitHide;
         }
+        if(Core.input.keyTap(Binding.lockonLastMark)){
+            MarkerType.lockOnLastMark();
+        }
+        if(Core.input.keyTap(Binding.point)){
+            MarkerType.selected.markWithMessage(Core.input.mouseWorld());
+        }
     }
 
     private static void registerBundle(){
diff --git a/core/src/mindustryX/features/MarkerType.java b/core/src/mindustryX/features/MarkerType.java
new file mode 100644
index 0000000000000000000000000000000000000000..c3850e910d6e9d579316734190e891d701681ffb
--- /dev/null
+++ b/core/src/mindustryX/features/MarkerType.java
@@ -0,0 +1,215 @@
+package mindustryX.features;
+
+import arc.*;
+import arc.func.*;
+import arc.graphics.*;
+import arc.graphics.g2d.*;
+import arc.math.*;
+import arc.math.geom.*;
+import arc.struct.*;
+import arc.util.*;
+import mindustry.*;
+import mindustry.arcModule.*;
+import mindustry.arcModule.ui.dialogs.*;
+import mindustry.entities.*;
+import mindustry.game.EventType.*;
+import mindustry.gen.*;
+import mindustry.graphics.*;
+import mindustryX.features.ui.*;
+
+import java.util.regex.*;
+
+import static arc.graphics.g2d.Draw.color;
+import static arc.graphics.g2d.Lines.stroke;
+import static mindustry.Vars.*;
+
+public class MarkerType{
+    private static final Pattern posPattern = Pattern.compile("(?<type><[A-Za-z]+>)?\\((?<x>\\d+),(?<y>\\d+)\\)");
+    /** 冷却时间 */
+    public static final float heatTime = 60f;
+    /** 滞留时间 */
+    public static final float retainTime = 1800f;
+    public static MarkerType mark, gatherMark, attackMark, defenseMark, quesMark;
+    public static Seq<MarkerType> allTypes;
+    public static MarkerType selected = mark;
+    private static MarkElement last;
+
+    public static void init(){
+        mark = new MarkerType("Mark", new Effect(1800, e -> {
+            color(e.color);
+            stroke(2f);
+            Lines.circle(e.x, e.y, 1f * tilesize);
+            stroke(e.fout() * 1.5f + 0.5f);
+            Lines.circle(e.x, e.y, 8f + e.finpow() * 92f);
+            //Drawf.arrow(player.x, player.y, e.x, e.y, 5f * tilesize, 4f, Pal.command);
+        }), Color.valueOf("eab678"));
+        gatherMark = new MarkerType("Gather", new Effect(1800, e -> {
+            color(e.color, 0.8f);
+            stroke(2f);
+            Lines.circle(e.x, e.y, 4f * tilesize);
+            stroke(1f);
+            Lines.circle(e.x, e.y, 4f * tilesize * (e.finpow() * 8f - (int)(e.finpow() * 8f)));
+            for(int j = 0; j < 4; j++){
+                if(e.fout() * 3 < j){
+                    for(int i = 0; i < 8; i++){
+                        float rot = i * 45f;
+                        float radius = 4f * tilesize + j * 6f + 4f;
+                        Drawf.simpleArrow(e.x + Angles.trnsx(rot, radius), e.y + Angles.trnsy(rot, radius), e.x, e.y, 4f, 2f, Color.cyan, Math.min(1f, j - e.fout() * 3));
+                    }
+                }
+            }
+        }), Color.cyan);
+        attackMark = new MarkerType("Attack", new Effect(1800, e -> {
+            color(e.color);
+            stroke(2f);
+            Lines.circle(e.x, e.y, 1f * tilesize);
+            float radius = 20f + e.finpow() * 80f;
+            Lines.circle(e.x, e.y, radius);
+            for(int i = 0; i < 4; i++){
+                float rot = i * 90f + 45f + (-Time.time) % 360f;
+                Drawf.simpleArrow(e.x + Angles.trnsx(rot, radius), e.y + Angles.trnsy(rot, radius), e.x, e.y, 6f + 4 * e.finpow(), 2f + 4 * e.finpow());
+            }
+        }), Color.valueOf("#DC143C"));
+        defenseMark = new MarkerType("Defend", new Effect(1800, e -> {
+            color(Pal.heal);
+            if(e.fin() < 0.2f){
+                Lines.circle(e.x, e.y, 20f + e.fin() * 400f);
+                return;
+            }
+            Lines.circle(e.x, e.y, 101f);
+            Lines.circle(e.x, e.y, 93f);
+            for(int i = 0; i < 16; i++){
+                float rot = i * 22.5f;
+                if((e.fin() - 0.2f) * 50 > i)
+                    Drawf.simpleArrow(e.x, e.y, e.x + Angles.trnsx(rot, 120f), e.y + Angles.trnsy(rot, 120f), 96f, 4f);
+            }
+        }), Color.acid);
+        quesMark = new MarkerType("What", new Effect(1200, e -> {
+            color(Color.violet);
+            stroke(2f);
+            Draw.alpha(Math.min(e.fin() * 5, 1));
+            Lines.arc(e.x, e.y + 25f, 10, 0.75f, 270);
+            Lines.line(e.x, e.y + 15f, e.x, e.y + 7f);
+            Lines.circle(e.x, e.y, 3f);
+            Lines.circle(e.x, e.y + 18.5f, 27f);
+        }), Color.pink);
+        allTypes = Seq.with(mark, gatherMark, attackMark, defenseMark, quesMark);
+    }
+
+    static{
+        init();
+        selected = mark;
+        Events.run(WorldLoadEvent.class, () -> last = null);
+    }
+
+
+    public final Color color;
+    private final String name;
+    private final Effect effect;
+    public String localizedName;
+
+    public MarkerType(String name, Effect effect, Color color){
+        this.name = name;
+        this.effect = effect;
+        this.color = color;
+
+        localizedName = Core.bundle.get("marker." + name + ".name", "unknown");
+    }
+
+    public String shortName(){
+        return "[#" + color + "]" + localizedName.charAt(0);
+    }
+
+    public MarkElement at(Position pos){
+        var element = new MarkElement(this, pos);
+        element.show();
+        return element;
+    }
+
+    public void markWithMessage(Vec2 pos){
+        if(last != null && last.time < heatTime){
+            Vars.ui.announce("请不要频繁标记!");
+            return;
+        }
+        last = at(pos);
+        UIExt.sendChatMessage(Strings.format("<ARCxMDTX>[#@]<@>[]@", color, name, FormatDefault.formatTile(pos)));
+    }
+
+    public static boolean resolveMessage(String text){
+        var matcher = posPattern.matcher(Strings.stripColors(text));
+        if(!matcher.find()) return false;
+        var typeName = matcher.group("type");
+        Vec2 pos = Tmp.v1.set(Strings.parseInt(matcher.group("x")), Strings.parseInt(matcher.group("y")));
+
+        MarkerType type = mark;
+        if(typeName != null){
+            typeName = typeName.substring(1, typeName.length() - 1);
+            for(var it : allTypes){
+                if(it.name.equals(typeName))
+                    type = it;
+            }
+        }else if(text.contains("集合")){
+            type = gatherMark;
+        }
+
+        var exists = (MarkElement)Groups.draw.find(it -> it instanceof MarkElement e && e.message == null && e.within(pos.scl(tilesize), 2 * tilesize));
+        last = exists != null ? exists : type.at(pos.scl(tilesize));
+        last.message = text;
+        MessageDialog.addMsg(new MessageDialog.advanceMsg(MessageDialog.arcMsgType.markLoc, text, pos));
+        return true;
+    }
+
+    public static void eachActive(Cons<MarkElement> cons){
+        if(last == null) return;
+        Groups.draw.each(d -> {
+            if(d instanceof MarkElement e) cons.get(e);
+        });
+    }
+
+    public static void lockOnLastMark(){
+        if(last == null) return;
+        control.input.panCamera(Tmp.v1.set(last));
+        last.show();
+    }
+
+    public static @Nullable Position getLastPos(){
+        return last;
+    }
+
+
+    public static class MarkElement extends EffectState{
+        public final MarkerType type;
+        @Nullable
+        public String message;
+
+        public MarkElement(MarkerType MarkerType, Position markPos){
+            this.type = MarkerType;
+
+            set(markPos);
+            this.effect = MarkerType.effect;
+            this.lifetime = effect.lifetime;
+            this.color.set(MarkerType.color);
+        }
+
+        public void show(){
+            time = 0;
+            add();
+        }
+
+        @Override
+        public void draw(){
+            super.draw();
+            showArrow();
+            if(message != null)
+                WorldLabel.drawAt(message, x, y, Layer.overlayUI, WorldLabel.flagOutline, 1);
+        }
+
+        private void showArrow(){
+            Draw.reset();
+            Drawf.arrow(player.x, player.y, x, y, 5f * tilesize, 4f, color);
+
+            var p = Tmp.v1.set(this).sub(player).limit(4.5f * tilesize).add(player);
+            DrawUtilities.drawText((int)(dst(player) / 8) + "", 0.2f, p.x, p.y, color, Align.center);
+        }
+    }
+}
diff --git a/core/src/mindustryX/features/UIExt.java b/core/src/mindustryX/features/UIExt.java
index d73cc555f9dfd3b4248707351e1ecfd6c261e686..a8740bc693f27bbfd3917a69c78417919eed6cad 100644
--- a/core/src/mindustryX/features/UIExt.java
+++ b/core/src/mindustryX/features/UIExt.java
@@ -5,6 +5,8 @@ import arc.scene.ui.*;
 import arc.scene.ui.layout.*;
 import arc.util.*;
 import mindustry.content.*;
+import mindustry.core.*;
+import mindustry.gen.*;
 import mindustryX.features.ui.*;
 
 import static mindustry.Vars.*;
@@ -33,11 +35,20 @@ public class UIExt{
             y.setText(String.valueOf(vec.y));
         }).tooltip(b -> b.label(() -> "选择玩家当前位置：" + player.tileX() + "," + player.tileY())).height(50f);
 
-//            tt.button(StatusEffects.blasted.emoji(), () -> {
-//                if(Marker.markList.size == 0) return;
-//                vec.set(World.toTile(Marker.markList.peek().markPos.x), World.toTile(Marker.markList.peek().markPos.y));
-//                x.setText(World.toTile(Marker.markList.peek().markPos.x) + "");
-//                y.setText(World.toTile(Marker.markList.peek().markPos.y) + "");
-//            }).tooltip(Marker.markList.size == 0 ? "[red]未标记" : ("选择上个标记点：" + World.toTile(Marker.markList.peek().markPos.x) + "," + World.toTile(Marker.markList.peek().markPos.y))).height(50f);
+        tt.button(StatusEffects.blasted.emoji(), () -> {
+            var last = MarkerType.getLastPos();
+            if(last == null) return;
+            vec.set(World.toTile(last.getX()), World.toTile(last.getY()));
+            x.setText(String.valueOf(vec.x));
+            y.setText(String.valueOf(vec.y));
+        }).height(50f).tooltip((t) -> t.label(() -> {
+            var last = MarkerType.getLastPos();
+            if(last == null) return "[red]未标记";
+            return "选择上个标记点：" + FormatDefault.formatTile(last);
+        }));
+    }
+
+    public static void sendChatMessage(String message){
+        Call.sendChatMessage(ui.chatfrag.mode.normalizedPrefix() + message);
     }
 }

From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Fri, 24 May 2024 19:45:32 +0800
Subject: [PATCH] API(LogicExt) limitUpdate

---
 core/src/mindustry/entities/EntityGroup.java | 12 ++++++++++++
 core/src/mindustryX/features/LogicExt.java   | 12 +++++++++++-
 2 files changed, 23 insertions(+), 1 deletion(-)

diff --git a/core/src/mindustry/entities/EntityGroup.java b/core/src/mindustry/entities/EntityGroup.java
index 9fdfda3d08ba6497d424fd19af7068f1f10622af..b93abc6277b89d4f8556c484d1e58dc388f3d390 100644
--- a/core/src/mindustry/entities/EntityGroup.java
+++ b/core/src/mindustry/entities/EntityGroup.java
@@ -6,6 +6,7 @@ import arc.math.geom.*;
 import arc.struct.*;
 import arc.util.*;
 import mindustry.gen.*;
+import mindustryX.features.*;
 
 import java.util.*;
 
@@ -80,6 +81,17 @@ public class EntityGroup<T extends Entityc> implements Iterable<T>{
     }
 
     public void update(){
+        if(LogicExt.limitUpdate){
+            Core.camera.bounds(viewport);
+            viewport.grow(LogicExt.limitDst * 2);
+            for(index = 0; index < array.size; index++){
+                Entityc e = array.items[index];
+                if(e instanceof Position p && !viewport.contains(p.getX(), p.getY()))
+                    continue;
+                array.items[index].update();
+            }
+            return;
+        }
         for(index = 0; index < array.size; index++){
             array.items[index].update();
         }
diff --git a/core/src/mindustryX/features/LogicExt.java b/core/src/mindustryX/features/LogicExt.java
index e71f51b27d8576727f19b3273a9a6f0536e610c7..373c2dfbd0f2cbe64811c8a1ca99172a82637556 100644
--- a/core/src/mindustryX/features/LogicExt.java
+++ b/core/src/mindustryX/features/LogicExt.java
@@ -1,11 +1,21 @@
 package mindustryX.features;
 
 import arc.*;
+import mindustry.*;
 import mindustry.game.EventType.*;
 
 public class LogicExt{
+    public static boolean limitUpdate = false;
+    public static int limitDst = 0, limitTimer = 10;
+
     public static void init(){
-        Events.run(Trigger.update, () -> {
+        Events.run(Trigger.preDraw, () -> {
+            limitUpdate = Core.settings.getBool("limitupdate");
+            limitDst = Core.settings.getInt("limitdst") * Vars.tilesize;
+            if(limitUpdate && limitTimer-- < 0){
+                limitUpdate = false;
+                limitTimer = 10;
+            }
         });
     }
 }
\ No newline at end of file

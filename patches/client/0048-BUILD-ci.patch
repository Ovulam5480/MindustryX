From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Wed, 10 Apr 2024 13:46:16 +0800
Subject: [PATCH] BUILD ci

---
 .github/actions/.gitignore        |  2 ++
 .github/actions/clearOldAssets.ts | 21 +++++++++++++++++++++
 .github/workflows/build.yml       |  6 ++++++
 3 files changed, 29 insertions(+)
 create mode 100644 .github/actions/.gitignore
 create mode 100644 .github/actions/clearOldAssets.ts

diff --git a/.github/actions/.gitignore b/.github/actions/.gitignore
new file mode 100644
index 0000000000000000000000000000000000000000..eba3e54426a2115c8ddba3b231c1ae3f05bcbbf6
--- /dev/null
+++ b/.github/actions/.gitignore
@@ -0,0 +1,2 @@
+/*
+!/*.ts
\ No newline at end of file
diff --git a/.github/actions/clearOldAssets.ts b/.github/actions/clearOldAssets.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cbe154c9479a5ead03734dc348e92156f82d837
--- /dev/null
+++ b/.github/actions/clearOldAssets.ts
@@ -0,0 +1,21 @@
+import * as core from "@actions/core"
+import {context, getOctokit} from "@actions/github"
+
+const octokit = getOctokit(import.meta.env.GITHUB_TOKEN) as import("@octokit/plugin-rest-endpoint-methods/dist-types/types").Api
+
+async function clearOldAssets(tag: string, keep: number = 9) {
+    const release = await octokit.rest.repos.getReleaseByTag({
+        ...context.repo, tag
+    })
+    const assets = release.data.assets.sort((a, b) => a.name < b.name ? 1 : -1)
+    if (assets.length <= keep) return
+    const toRemove = assets.slice(keep)
+    console.log("ToRemove", toRemove.map(it => it.name))
+    await Promise.all(toRemove.map(it =>
+        octokit.rest.repos.deleteReleaseAsset({
+            ...context.repo, asset_id: it.id
+        })
+    ))
+}
+
+await clearOldAssets(core.getInput("release") || import.meta.env.TAG)
\ No newline at end of file
diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml
index be5a1ccb0b2baf28e94ab935566b9b725d57eabe..df89682d6c5c86cccd4df9f7dbba9486d2aa7485 100644
--- a/.github/workflows/build.yml
+++ b/.github/workflows/build.yml
@@ -60,3 +60,9 @@ jobs:
           target_commitish: ${{github.sha}}
           files: artifacts/*
           prerelease: true
+      - uses: oven-sh/setup-bun@v1
+      - name: clearOldAssets
+        run: bun run .github/actions/clearOldAssets.ts
+        env:
+          GITHUB_TOKEN: ${{github.token}}
+          TAG: ${{ env.RELEASE_TAG }}
